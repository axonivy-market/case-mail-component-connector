<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:f="http://xmlns.jcp.org/jsf/core"
	xmlns:h="http://xmlns.jcp.org/jsf/html"
	xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
	xmlns:cc="http://xmlns.jcp.org/jsf/composite"
	xmlns:ic="http://ivyteam.ch/jsf/component"
	xmlns:p="http://primefaces.org/ui"
	xmlns:pe="http://primefaces.org/ui/extensions"
	xmlns:c="http://xmlns.jcp.org/jsp/jstl/core">
<cc:interface componentType="IvyComponent">
	<cc:attribute name="id" required="true" />
	<cc:attribute name="mailBrowserId" required="true"
		shortDescription="The absolute client ID of the included component in the JSF view. For example 'form:mailBrowser'" />
	<cc:attribute name="caseId"
		shortDescription="Specifies the Case ID associated with the email." />
	<cc:attribute name="caseRef"
		shortDescription="Specifies the Case Reference associated with the email. Example: [Ref=C-2025-01], where C-2025-01 is the case code. 
		It must match the regex defined in the caseReferenceRegex variable for receive email feature" />
</cc:interface>

<cc:implementation>
	<h:outputStylesheet name="layouts/styles/custom-style.css" />
	<h:panelGroup id="mailBrowser">
		<c:set target="#{mailBean}" property="caseId"
			value="#{cc.attrs.caseId}" />
		<c:set target="#{mailBean}" property="caseRef"
			value="#{cc.attrs.caseRef}" />
		<f:event listener="#{mailBean.initMail}" type="preRenderComponent"></f:event>
		<div class="flex justify-content-between">
			<div>
				<h2>#{ivy.cms.co("/Labels/emailDetails")}</h2>
			</div>
			<div class="flex justify-content-end mb-2">
				<p:commandButton id="newMailBtn" process="@this"
					value="#{ivy.cms.co('/Button/newMail')}"
					actionListener="#{mailBean.initMail()}" icon="pi pi-envelope"
					oncomplete="PF('newEmailDialog').show()" />
			</div>
		</div>

		<!-- Email list table -->
		<p:dataTable var="mail" value="#{mailBean.mailModel}"
			rowIndexVar="rowIndex" id="mailTable" paginator="true"
			paginatorPosition="bottom" rows="5"
			rowsPerPageTemplate="5,10,15,25,50,100" lazy="true"
			selectionMode="single" selection="#{mailBean.selectedMail}">
			<p:ajax event="rowSelect" update="@parent:viewMailComponent"
				listener="#{mailBean.handleSelectMail}" />
			<p:column headerText="#{ivy.cms.co('/Labels/createdDate')}"
				sortBy="#{mail.createdDate}" sortOrder="desc">
				<h:outputText value="#{mailBean.formatDate(mail.createdDate)}"
					title="#{mailBean.formatDate(mail.createdDate)}" />
			</p:column>
			<p:column headerText="#{ivy.cms.co('/Labels/status')}"
				sortBy="#{mail.status}" width="10%">
				<h:outputText value="#{mail.status.getCms()}"
					title="#{mail.status.getCms()}" />
			</p:column>
			<p:column headerText="#{ivy.cms.co('/Mail/from')}"
				sortBy="#{mail.sender}">
				<h:outputText value="#{mail.sender}" title="#{mail.sender}" />
			</p:column>
			<p:column headerText="#{ivy.cms.co('/Mail/to')}"
				sortBy="#{mail.recipient}">
				<h:outputText value="#{mailBean.textEllipsis(mail.recipient, 25)}"
					title="#{mail.recipient}" />
			</p:column>
			<p:column headerText="#{ivy.cms.co('/Mail/subject')}"
				sortBy="#{mail.subject}">
				<h:outputText value="#{mailBean.textEllipsis(mail.subject, 25)}"
					title="#{mail.subject}" />
			</p:column>
		</p:dataTable>

		<h:panelGroup id="viewMailComponent">
			<h:panelGroup rendered="#{not empty mailBean.selectedMail.id}">
				<!-- Actions -->
				<c:if test="#{mailBean.selectedMail.status ne 'SMTP_FAILED'}">
					<div class="flex mt-2">
						<p:commandButton id="replyEmail" process="@this"
							value="#{ivy.cms.co('/Button/reply')}"
							update="@([id$=newEmailDialog])" icon="si si-arrow-left"
							actionListener="#{mailBean.prepareMail('REPLY')}"
							oncomplete="PF('newEmailDialog').show()" />
						<p:commandButton id="forwardEmail"
							value="#{ivy.cms.co('/Button/forward')}"
							update="@([id$=newEmailDialog])" icon="si si-arrow-right"
							process="@this"
							actionListener="#{mailBean.prepareMail('FORWARD')}"
							oncomplete="PF('newEmailDialog').show()" styleClass="m-0 mx-1" />
						<p:commandButton id="resendEmail" process="@this"
							value="#{ivy.cms.co('/Button/resend')}"
							rendered="#{mailBean.isSent()}" update="@([id$=newEmailDialog])"
							icon="si si-undo" oncomplete="PF('newEmailDialog').show()"
							actionListener="#{mailBean.prepareMail('RESEND')}"
							styleClass="ml-0">
							<p:confirm header="#{ivy.cms.co('/Labels/confirmation')}"
								message="#{mailBean.getConfirmMessage()}" escape="false"
								icon="si si-road-sign-warning" />
						</p:commandButton>
						<p:confirmDialog global="true" showEffect="fade" hideEffect="fade"
							responsive="true" width="auto">
							<p:commandButton id="confirm-no-button"
								value="#{ivy.cms.co('/Button/no')}" type="button"
								styleClass="ui-confirmdialog-no ui-button-flat" />
							<p:commandButton id="confirm-yes-button"
								value="#{ivy.cms.co('/Button/yes')}" type="button"
								styleClass="ui-confirmdialog-yes" />
						</p:confirmDialog>
					</div>
				</c:if>

				<!-- Mail Details -->
				<p:fieldset id="mailDetail"
					legend="#{ivy.cms.co('/Labels/emailDetails')}" toggleable="true"
					toggleSpeed="500" styleClass="mt-4">
					<div class="grid w-full">
						<div class="col-12 mb-1">
							<h:outputLabel for="subject"
								value="#{ivy.cms.co('/Mail/subject')}" styleClass="block mb-2" />
							<p:inputText id="subject"
								value="#{mailBean.selectedMail.subject}" readonly="true"
								styleClass="w-full" />
						</div>
					</div>
					<div class="grid w-full">
						<div class="col-12 md:col-6 mb-1">
							<h:outputLabel for="from" value="#{ivy.cms.co('/Mail/from')}"
								styleClass="block mb-2" />
							<p:inputText id="from" value="#{mailBean.selectedMail.sender}"
								readonly="true" styleClass="w-full" />
						</div>
						<div class="col-12 md:col-6 mb-1">
							<h:outputLabel for="to" value="#{ivy.cms.co('/Mail/to')}"
								styleClass="block mb-2" />
							<p:inputText id="to" value="#{mailBean.selectedMail.recipient}"
								readonly="true" styleClass="w-full" />
						</div>
					</div>
					<div class="grid w-full">
						<div class="col-12 md:col-6 mb-1">
							<h:outputLabel for="cc" value="#{ivy.cms.co('/Mail/cc')}"
								styleClass="block mb-2" />
							<p:inputText id="cc" value="#{mailBean.selectedMail.recipientCC}"
								readonly="true" styleClass="w-full" />
						</div>
						<div class="col-12 md:col-6 mb-1">
							<h:outputLabel for="sent" value="#{ivy.cms.co('/Mail/sent')}"
								styleClass="block mb-2" />
							<p:inputText id="sent"
								value="#{mailBean.formatDate(mailBean.selectedMail.sentDate)}"
								readonly="true" styleClass="w-full" />
						</div>
					</div>
					<div class="grid w-full">
						<div class="col-12 mb-1">
							<h:outputLabel for="attachments"
								value="#{ivy.cms.co('/Mail/attachments')}"
								styleClass="block mb-2" />
							<p:outputPanel
								styleClass="border-round-md gap-1 flex flex-wrap overflow-y-auto max-h-10rem custom-chip p-1">
								<ui:repeat var="attachment" value="#{mailBean.attachments}">
									<p:chip label="#{attachment.name} - #{attachment.size} KB"
										icon="pi #{mailBean.getAttachmentIcon(attachment.contentType)}"
										styleClass="chip-hover" removable="false">
										<p:ajax listener="#{mailBean.viewDocument(attachment)}"
											process="@this" update="@widgetVar(documentViewerWidget)"
											oncomplete="PF('documentViewerWidget').show()" />
									</p:chip>
								</ui:repeat>
							</p:outputPanel>
						</div>
					</div>
					<c:if test="#{not empty mailBean.selectedMail.body}">
						<div class="grid w-full">
							<div class="col-12">
								<div class="iframe-wrapper border-round-md overflow-hidden mx-0"
									style="border: 1px solid #dcdcdc; height: 400px;">
									<iframe id="emailContent" sandbox="allow-same-origin"
										srcdoc="#{mailBean.getMailBodyWithEmbeddedImages()}"
										class="iframe-mail-body w-full h-full" style="border: 0;" />
								</div>
							</div>
						</div>
					</c:if>
				</p:fieldset>
			</h:panelGroup>
		</h:panelGroup>
		<p:growl id="validationGrowl" showDetail="true" showSummary="true"
			skipDetailIfEqualsSummary="true" widgetVar="validationGrowlWidget"
			escape="true" globalOnly="true" />

		<!-- Email Dialog -->
		<ic:com.axonivy.connector.mail.NewMailDialog id="newMail"
			mail="#{mailBean.mail}"
			newMailDialogId="#{cc.attrs.mailBrowserId}:newMail" />

		<!-- Document Viewer Dialog -->
		<p:dialog id="documentViewerDlg" widgetVar="documentViewerWidget"
			header="#{ivy.cms.co('/Document/documentPreview')}" modal="true"
			resizable="true" maximizable="true" closable="true" width="60%"
			height="60%">
			<ic:com.axonivy.connector.mail.DocumentViewer
				pdfViewerPanelGroupStyle="new-mail-pdf-preview" />
		</p:dialog>
	</h:panelGroup>
</cc:implementation>

</html>
